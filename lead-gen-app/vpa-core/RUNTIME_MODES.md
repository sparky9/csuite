# Runtime Modes & Installer Flow

Design reference for letting solopreneurs choose how the VPA talks to language models during setup.

## Supported Modes

| Mode             | Description                                      | Best For                                                  | Requirements                                     |
| ---------------- | ------------------------------------------------ | --------------------------------------------------------- | ------------------------------------------------ |
| `claude-desktop` | Local stdio bridge into Claude Desktop           | Users already working inside Claude Desktop               | Claude Desktop running, desktop bridge installed |
| `claude-api`     | Direct Anthropic API access                      | Hosted deployments, higher reliability                    | Anthropic API key, internet access               |
| `openai`         | OpenAI GPT-4o/4.1 with function calling          | Users with OpenAI credits, strong structured tool-calling | OpenAI API key                                   |
| `gemini`         | Google Gemini 1.5 (functions or prompt fallback) | Teams invested in Google stack                            | Google API project w/ Gemini access              |
| `ollama`         | Fully local models via Ollama REST               | Privacy-first, zero subscription cost                     | Ollama installed, compatible model downloaded    |

## Installer Decision Flow

1. **Detect Claude Desktop bridge**
   - If the MCP bridge executable is present, offer “Use Claude Desktop (local)” as the recommended option.
   - Prompt for fallback preference (Anthropic/OpenAI/Gemini/Ollama).
2. **Collect API credentials (if needed)**
   - For each selected cloud adapter, gather and validate the API key.
   - Store encrypted in `config/runtime.json` or system keychain.
3. **Set priority order**
   - Present drag-and-drop list mirroring `VPA_ADAPTER_PRIORITY`.
   - Toggle “Enable automatic failover” (maps to `VPA_FAILOVER_ENABLED`).
4. **Write config**
   - Persist to `.env` or `config/runtime.json`:
     ```json
     {
       "defaultMode": "claude-desktop",
       "adapterPriority": ["claude-desktop", "claude-api", "openai"],
       "failoverEnabled": true
     }
     ```
5. **Run diagnostics**
   - Ping each adapter (Claude Desktop stdio, API auth checks, Ollama health).
   - Display readiness badges in installer summary.

## Runtime Config Sources

Priority order when loading settings:

1. Explicit `.env` values (`VPA_RUNTIME_MODE`, `VPA_ADAPTER_PRIORITY`, `VPA_FAILOVER_ENABLED`).
2. JSON config generated by installer (future `config/runtime.json`).
3. Defaults from `src/config/runtime.ts` (local-first, failover enabled).

Additional environment knobs:

- `CLAUDE_API_MODEL` – overrides Anthropic model when the Claude API adapter is active.
- `OPENAI_ROUTER_MODEL` – swap the lightweight router model (default `gpt-4o-mini`).

## Failover Policy

- When failover enabled, the bridge uses the adapter priority list.
- On adapter error (timeouts, auth failure, process exit), the next adapter is tried.
- After 3 failed attempts, an error event is emitted to the bridge SSE stream.
- Successful response resets failure counter for that adapter.

## UI Copy Sketch

- **Title**: “Choose how the VPA talks to your AI models.”
- **Options**:
  1. **Claude Desktop (local & free)** – Requires Claude Desktop open.
  2. **Anthropic API (Claude API)** – Pay-as-you-go reliability.
  3. **OpenAI GPT-4o** – Broad ecosystem support.
  4. **Google Gemini** – Works with Workspace tooling.
  5. **Ollama Local** – Offline and private.
- **Failover Toggle**: “If my first choice is unavailable, automatically roll to the next one.”
- **Summary**: “Your VPA will start with Claude Desktop. If it’s offline, it will try Anthropic API, then OpenAI.”

## Next Steps

- Build `config/runtime.json` writer inside the installer script.
- Autodetect Claude Desktop bridge process on Windows/macOS.
- Extend bridge adapters (`src/bridge`) to respect the runtime config. [done] Local, Claude API, and OpenAI adapters honor priority today.
- Surface runtime mode + failover status in `vpa_status` → `report_type: "modules"` metadata. [done] Runtime block now included.
