// Prisma Schema for @ocsuite/db
// Multi-tenant architecture with Row-Level Security (RLS) enforcement

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================================================
// CORE TENANT MODEL
// ============================================================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]

  @@index([slug])
  @@map("tenants")
}

// ============================================================================
// USER & MEMBERSHIP MODELS
// ============================================================================

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]
  tenantMemberships TenantMember[]
  conversations     Conversation[]
  tasks             Task[]

  @@index([clerkId])
  @@index([email])
  @@map("users")
}

model TenantMember {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  role      TenantMemberRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("tenant_members")
}

enum TenantMemberRole {
  owner
  admin
  member
}

// ============================================================================
// CONVERSATION & MESSAGE MODELS
// ============================================================================

model Conversation {
  id          String      @id @default(cuid())
  tenantId    String
  userId      String
  personaType PersonaType
  title       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([tenantId])
  @@index([userId])
  @@index([personaType])
  @@index([createdAt])
  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  tenantId       String
  role           MessageRole
  content        String   @db.Text
  metadata       Json?
  createdAt      DateTime @default(now())

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([tenantId])
  @@index([createdAt])
  @@map("messages")
}

enum PersonaType {
  ceo
  cfo
  cmo
  cto
}

enum MessageRole {
  user
  assistant
  system
}

// ============================================================================
// CONNECTOR MODELS
// ============================================================================

model Connector {
  id                     String            @id @default(cuid())
  tenantId               String
  provider               ConnectorProvider
  status                 ConnectorStatus
  encryptedAccessToken   String            @db.Text
  encryptedRefreshToken  String?           @db.Text
  tokenExpiresAt         DateTime?
  scopes                 String[]
  metadata               Json?
  lastSyncedAt           DateTime?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider])
  @@index([tenantId])
  @@index([provider])
  @@index([status])
  @@map("connectors")
}

enum ConnectorProvider {
  google
  gmail
  slack
  notion
  stripe
}

enum ConnectorStatus {
  active
  error
  disconnected
  pending
}

// ============================================================================
// TASK EXECUTION MODELS
// ============================================================================

model Task {
  id         String       @id @default(cuid())
  tenantId   String
  userId     String
  type       String
  status     TaskStatus
  priority   TaskPriority
  payload    Json
  result     Json?
  error      String?      @db.Text
  jobId      String?
  queueName  String?
  executedAt DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([type])
  @@index([jobId])
  @@index([queueName])
  @@index([createdAt])
  @@map("tasks")
}

enum TaskStatus {
  pending
  running
  completed
  failed
}

enum TaskPriority {
  low
  normal
  high
  urgent
}

// ============================================================================
// USAGE & METRICS MODELS
// ============================================================================

model UsageSnapshot {
  id            String   @id @default(cuid())
  tenantId      String
  date          DateTime @db.Date
  apiCalls      Int      @default(0)
  tokensUsed    Int      @default(0)
  tasksExecuted Int      @default(0)
  storageBytes  BigInt   @default(0)
  createdAt     DateTime @default(now())

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([date])
  @@map("usage_snapshots")
}

// ============================================================================
// KNOWLEDGE BASE MODELS
// ============================================================================

model KnowledgeEntry {
  id        String                        @id @default(cuid())
  tenantId  String?                       // null = company-wide knowledge
  source    String
  content   String                        @db.Text
  embedding Unsupported("vector(1536)")?  // pgvector embedding
  metadata  Json?
  createdAt DateTime                      @default(now())
  updatedAt DateTime                      @updatedAt

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([source])
  @@index([createdAt])
  @@map("knowledge_entries")
}

// ============================================================================
// BUSINESS PROFILE MODEL
// ============================================================================

model BusinessProfile {
  id        String         @id @default(cuid())
  tenantId  String         @unique
  industry  String?
  size      BusinessSize?
  revenue   String?
  stage     BusinessStage?
  goals     String[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  // Relations
members            TenantMember[]  conversations      Conversation[]  messages           Message[]  connectors         Connector[]  tasks              Task[]  usageSnapshots     UsageSnapshot[]  knowledgeEntries   KnowledgeEntry[]  businessProfile    BusinessProfile?  moduleInsights     ModuleInsight[]  analyticsSnapshots AnalyticsSnapshot[]
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("business_profiles")
}

enum BusinessSize {
  solo
  small
  medium
  large
}

enum BusinessStage {
  idea
  startup
  growth
  mature
}
